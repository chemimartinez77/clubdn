generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Estados posibles de un usuario
enum UserStatus {
  PENDING_VERIFICATION
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SUSPENDED
}

// Roles de usuario
enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}


enum ReportType {
  BUG
  MEJORA
}

enum ReportStatus {
  NUEVO
  EN_REVISION
  EN_PROGRESO
  HECHO
}

enum ReportPriority {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum ReportSeverity {
  NO_URGE
  ME_MOLESTA
  BLOQUEANTE
}

// Tipos de membresía
enum MembershipType {
  SOCIO        // 19€/mes, con llave, requiere 1 año como COLABORADOR + aprobación
  COLABORADOR  // 15€/mes, sin llave
  FAMILIAR     // Vinculado a un socio
  EN_PRUEBAS   // Periodo de prueba
  BAJA         // Usuario dado de baja
}

// Modelo de Usuario
model User {
  id                String      @id @default(cuid())
  email             String      @unique
  name              String
  password          String
  role              UserRole    @default(USER)
  status            UserStatus  @default(PENDING_VERIFICATION)
  
  emailVerified     Boolean     @default(false)
  verificationToken String?     @unique
  tokenExpiry       DateTime?

  resetPasswordToken String?    @unique
  resetPasswordExpiry DateTime?

  approvedBy        String?
  approvedAt        DateTime?
  rejectedBy        String?
  rejectedAt        DateTime?
  rejectionReason   String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  lastLoginAt       DateTime?
  
  approvedByAdmin   User?       @relation("ApprovedUsers", fields: [approvedBy], references: [id])
  approvedUsers     User[]      @relation("ApprovedUsers")
  rejectedByAdmin   User?       @relation("RejectedUsers", fields: [rejectedBy], references: [id])
  rejectedUsers     User[]      @relation("RejectedUsers")

  profile           UserProfile?
  organizedEvents   Event[]              @relation("EventOrganizer")
  cancelledEvents   Event[]              @relation("EventCancelledBy")
  eventRegistrations EventRegistration[]
  membership        Membership?
  payments          Payment[]
  invitationsCreated  Invitation[]      @relation("InvitationsCreated")
  invitationsValidated Invitation[]     @relation("InvitationsValidated")
  loginAttempts     LoginAttempt[]
  uploadedDocuments Document[]
  uploadedPhotos    EventPhoto[]
  reports           Report[]
  reportVotes       ReportVote[]
  eventAuditLogs    EventAuditLog[] @relation("EventAuditActor")
  eventAuditTargets EventAuditLog[] @relation("EventAuditTargetUser")
  notifications     Notification[]
  badges            UserBadge[]
  gamePlayHistory   GamePlayHistory[]

  @@index([email])
  @@index([status])
  @@index([verificationToken])
}

// Perfil extendido de usuario
model UserProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Información personal
  avatar          String?  // URL o path del avatar
  firstName       String?
  lastName        String?
  dni             String?
  dniNormalized   String?
  imageConsentActivities Boolean @default(false)
  imageConsentSocial     Boolean @default(false)
  phone           String?
  birthDate       DateTime?
  bio             String?  @db.Text

  // Preferencias de juegos
  favoriteGames   String[] // Array de nombres de juegos favoritos
  playStyle       String?  // Competitivo, Casual, Social, etc.

  // Social
  discord         String?
  telegram        String?

  // Configuración
  notifications   Boolean  @default(true)
  emailUpdates    Boolean  @default(true)

  // Preferencias de notificaciones
  notifyNewEvents       Boolean @default(true)   // Notificar nuevas partidas
  notifyEventChanges    Boolean @default(true)   // Cambios en eventos inscritos
  notifyEventCancelled  Boolean @default(true)   // Eventos cancelados
  notifyInvitations     Boolean @default(true)   // Estado de invitaciones

  // Personalización
  noughterColor   String?  // Color de Noughter: purple, blue, green, red, brown (null = usar tema activo)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([dniNormalized])
}

model EmailLog {
  id          String   @id @default(cuid())
  to          String
  subject     String
  template    String
  sentAt      DateTime @default(now())
  success     Boolean
  errorMsg    String?

  @@index([to])
  @@index([sentAt])
}

// Registro de intentos de login
model LoginAttempt {
  id          String   @id @default(cuid())
  email       String
  ipAddress   String?
  userAgent   String?
  success     Boolean
  failureReason String?  // "invalid_credentials", "pending_verification", "pending_approval", "rejected", "suspended"
  userId      String?   // Solo si el login fue exitoso o si el usuario existe
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  attemptedAt DateTime @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([success])
  @@index([attemptedAt])
  @@index([userId])
}

// Tipos de eventos
enum EventType {
  PARTIDA
  TORNEO
  OTROS
}

// Estados de eventos
enum EventStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

// Estados de registro
enum RegistrationStatus {
  CONFIRMED
  CANCELLED
  WAITLIST
}

enum InvitationStatus {
  PENDING
  USED
  EXPIRED
  CANCELLED
}

// Modelo de Evento
model Event {
  id              String   @id @default(cuid())
  title           String
  description     String   @db.Text

  // Tipo de evento
  type            EventType @default(OTROS)

  // Datos del juego (opcional, para partidas)
  gameName        String?
  gameImage       String?
  bggId           String?
  game            Game?    @relation("GameEvents", fields: [bggId], references: [id])
  gameCategory    BadgeCategory? // Categoría para tracking de badges

  // Fecha y hora
  date            DateTime
  startHour       Int?      // 0-23
  startMinute     Int?      // 0, 15, 30, 45
  durationHours   Int?      // Duración estimada en horas
  durationMinutes Int?      // Duración estimada en minutos

  // Ubicación
  location        String
  address         String?

  // Capacidad
  maxAttendees    Int
  registrations   EventRegistration[]
  invitations     Invitation[]
  eventGuests     EventGuest[]
  photos          EventPhoto[]
  auditLogs       EventAuditLog[]
  gamePlayHistory GamePlayHistory[]

  // Estado
  status          EventStatus @default(SCHEDULED)
  cancelledAt     DateTime?
  cancelledById   String?
  cancelledBy     User?     @relation("EventCancelledBy", fields: [cancelledById], references: [id])

  // Organizador
  createdBy       String
  organizer       User     @relation("EventOrganizer", fields: [createdBy], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([date])
  @@index([status])
  @@index([createdBy])
  @@index([type])
}

model Invitation {
  id                  String           @id @default(cuid())
  token               String           @unique
  memberId            String
  member              User             @relation("InvitationsCreated", fields: [memberId], references: [id], onDelete: Cascade)
  guestFirstName      String
  guestLastName       String
  guestDni            String
  guestDniNormalized  String
  eventId             String
  event               Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  validDate           DateTime
  status              InvitationStatus @default(PENDING)
  isExceptional       Boolean          @default(false)
  validatedByUserId   String?
  validatedBy         User?            @relation("InvitationsValidated", fields: [validatedByUserId], references: [id])
  usedAt              DateTime?
  createdAt           DateTime         @default(now())
  eventGuest          EventGuest?

  @@index([eventId])
  @@index([memberId])
  @@index([status])
  @@index([validDate])
  @@index([guestDniNormalized])
}

model EventGuest {
  id            String     @id @default(cuid())
  eventId       String
  event         Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  invitationId  String     @unique
  invitation    Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)
  guestFirstName String
  guestLastName  String
  guestDni       String
  createdAt     DateTime   @default(now())
  auditLogs      EventAuditLog[]

  @@index([eventId])
  @@index([guestDni])
}

// Registro a eventos
model EventRegistration {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  status      RegistrationStatus @default(CONFIRMED)

  cancelledAt DateTime?
  createdAt   DateTime @default(now())

  @@unique([eventId, userId])
  @@index([userId])
  @@index([status])
}

// Membresía del usuario
model Membership {
  id                String         @id @default(cuid())
  userId            String         @unique
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  type              MembershipType @default(COLABORADOR)
  monthlyFee        Decimal        @default(15.00) @db.Decimal(10, 2)

  // Fechas importantes
  startDate         DateTime       @default(now())  // Fecha de inicio como miembro
  becameSocioAt     DateTime?      // Fecha en que pasó a SOCIO (si aplica)
  fechaBaja         DateTime?      // Fecha de baja del miembro

  // Estado de pagos
  isActive          Boolean        @default(true)   // Si está al día con los pagos
  lastPaymentDate   DateTime?      // Último pago registrado
  nextPaymentDue    DateTime?      // Próxima fecha de pago

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([userId])
  @@index([type])
  @@index([isActive])
  @@index([fechaBaja])
}

// Historial de cambios de tipo de membresía
model MembershipChangeLog {
  id            String         @id @default(cuid())
  userId        String

  // Cambio realizado
  previousType  MembershipType?  // null si es la primera membresía
  newType       MembershipType
  reason        String?          @db.Text  // Motivo del cambio

  // Auditoría
  changedBy     String           // ID del admin que hizo el cambio
  changedAt     DateTime         @default(now())

  createdAt     DateTime         @default(now())

  @@index([userId])
  @@index([changedAt])
  @@index([changedBy])
}

// Registro de pagos
model Payment {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount          Decimal  @db.Decimal(10, 2)
  month           Int      // 1-12
  year            Int      // 2024, 2025, etc.

  // Información del pago
  paymentMethod   String?  // "efectivo", "transferencia", "bizum", etc.
  reference       String?  // Número de referencia o comprobante
  notes           String?  @db.Text

  // Registro
  registeredBy    String   // Admin que registró el pago
  paidAt          DateTime @default(now())

  createdAt       DateTime @default(now())

  @@unique([userId, month, year]) // Un pago por mes/año por usuario
  @@index([userId])
  @@index([year, month])
  @@index([paidAt])
}

// Juego de mesa (BoardGameGeek)
model Game {
  id                String   @id // BGG ID

  // Nombres
  name              String   // Nombre principal
  alternateNames    String[] // Nombres alternativos en otros idiomas

  // Información básica
  description       String?  @db.Text
  yearPublished     Int?

  // Imágenes
  image             String?  // URL de imagen grande
  thumbnail         String?  // URL de miniatura

  // Jugadores
  minPlayers        Int?
  maxPlayers        Int?

  // Tiempo de juego (en minutos)
  playingTime       Int?     // Tiempo típico
  minPlaytime       Int?     // Tiempo mínimo
  maxPlaytime       Int?     // Tiempo máximo

  // Edad
  minAge            Int?

  // Estadísticas de BGG
  usersRated        Int?
  averageRating     Float?
  bayesAverage      Float?
  rank              Int?     // Overall rank
  strategyRank      Int?     // Strategy game rank
  complexityRating  Float?   // Weight/complexity (1-5)

  // Comunidad
  numOwned          Int?
  numWanting        Int?
  numWishing        Int?
  numComments       Int?

  // Categorías (arrays de strings)
  categories        String[] // Economic, Exploration, Nautical, Pirates, etc.
  mechanics         String[] // Hand Management, Set Collection, etc.
  families          String[] // Components, Themes, etc.

  // Categoría para badges (asignada manualmente)
  badgeCategory     BadgeCategory?

  // Creadores
  designers         String[] // Nombres de diseñadores
  artists           String[] // Nombres de artistas
  publishers        String[] // Editoriales

  // Metadatos
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastSyncedAt      DateTime @default(now()) // Última vez que se sincronizó con BGG

  // Relación con eventos
  events            Event[]  @relation("GameEvents")

  @@index([name])
  @@index([yearPublished])
  @@index([rank])
  @@index([averageRating])
}

// Configuración del club
model ClubConfig {
  id        String   @id @default("club_config") // Solo habrá un registro

  // Tipos de membresía disponibles con sus configuraciones
  membershipTypes Json // Array de objetos con: { type, displayName, price, hasKey, description }

  // Otras configuraciones del club
  clubName       String   @default("Club DN")
  clubEmail      String?
  clubPhone      String?
  clubAddress    String?

  // Configuración de cuotas
  defaultCurrency String  @default("EUR")
  inviteMaxActive Int     @default(5)
  inviteMaxMonthly Int    @default(10)
  inviteMaxGuestYear Int  @default(5)
  inviteAllowSelfValidation Boolean @default(false)

  // Metadatos
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Tipos de juegos en la ludoteca
enum GameType {
  WARGAME
  MESA
  CARTAS
  MINI
  ROL
}

// Estados de condición física del juego
enum GameCondition {
  NUEVO
  BUENO
  REGULAR
  MALO
}

// Item físico en la ludoteca del club
model LibraryItem {
  id                String         @id @default(cuid())

  // Identificadores
  bggId             String?        // BGG ID del juego (almacenado como referencia, puede no estar en la tabla Game)
  internalId        String         @unique // ID interno del club

  // Información del juego
  name              String
  description       String?        @db.Text
  notes             String?        @db.Text

  // Clasificación
  gameType          GameType       // wargame, mesa, cartas, mini, rol
  condition         GameCondition  // Nuevo, Bueno, Regular, Malo

  // Propiedad y adquisición
  ownerEmail        String?        // Email del propietario (si no es del club)
  acquisitionDate   DateTime?      // Fecha de adquisición

  // Metadatos
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([name])
  @@index([gameType])
  @@index([condition])
  @@index([ownerEmail])
  @@index([bggId])
}

// Visibilidad de documentos
enum DocumentVisibility {
  PUBLIC      // Todos los miembros autenticados
  ADMIN       // Solo ADMIN y SUPER_ADMIN
  SUPER_ADMIN // Solo SUPER_ADMIN
}

// Documentos del club
model Document {
  id            String             @id @default(cuid())

  // Metadatos del archivo
  title         String
  filename      String             // Nombre original del archivo
  mimeType      String             // application/pdf, image/png, etc.
  size          Int                // Tamaño en bytes

  // Contenido binario (almacenado en BYTEA)
  content       Bytes

  // Permisos/Visibilidad
  visibility    DocumentVisibility @default(PUBLIC)

  // Auditoría
  uploadedById  String
  uploadedBy    User               @relation(fields: [uploadedById], references: [id])
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([visibility])
  @@index([uploadedById])
  @@index([title])
}

// Fotos de eventos (almacenadas en Cloudinary)
model EventPhoto {
  id            String   @id @default(cuid())
  eventId       String
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Datos de Cloudinary
  cloudinaryId  String   // public_id de Cloudinary
  url           String   // URL de la imagen
  thumbnailUrl  String?  // URL de miniatura (transformación de Cloudinary)

  // Metadatos
  uploadedById  String
  uploadedBy    User     @relation(fields: [uploadedById], references: [id])
  caption       String?  // Descripción opcional de la foto

  createdAt     DateTime @default(now())

  @@index([eventId])
  @@index([uploadedById])
}


model Report {
  id               String         @id @default(cuid())
  userId           String
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  type             ReportType
  title            String
  description      String         @db.Text
  screenshotUrl    String?
  originUrl        String?
  status           ReportStatus   @default(NUEVO)
  internalPriority ReportPriority @default(MEDIA)
  perceivedSeverity ReportSeverity
  devResponse      String?        @db.Text
  votesCount       Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  votes            ReportVote[]

  @@index([userId])
  @@index([status])
  @@index([internalPriority])
  @@index([createdAt])
}

model ReportVote {
  id        String   @id @default(cuid())
  reportId  String
  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([reportId, userId])
  @@index([reportId])
  @@index([userId])
}

enum EventAuditAction {
  REGISTER
  UNREGISTER
  REMOVE_PARTICIPANT
  INVITE
  CANCEL_INVITE
  CLOSE_CAPACITY
}

model EventAuditLog {
  id            String           @id @default(cuid())
  eventId       String
  event         Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  actorId       String
  actor         User             @relation("EventAuditActor", fields: [actorId], references: [id], onDelete: Cascade)
  action        EventAuditAction
  targetUserId  String?
  targetUser    User?            @relation("EventAuditTargetUser", fields: [targetUserId], references: [id])
  targetGuestId String?
  targetGuest   EventGuest?      @relation(fields: [targetGuestId], references: [id])
  createdAt     DateTime         @default(now())
  details       String?          @db.Text

  @@index([eventId])
  @@index([actorId])
  @@index([action])
}

// Categorías de badges
enum BadgeCategory {
  EUROGAMES
  TEMATICOS
  WARGAMES
  ROL
  MINIATURAS
  WARHAMMER
  FILLERS_PARTY
  CATALOGADOR
}

// Tipos de notificaciones
enum NotificationType {
  EVENT_CANCELLED         // Partida cancelada
  EVENT_MODIFIED          // Partida modificada (fecha/hora/ubicación)
  EVENT_CREATED           // Nueva partida creada (si tiene habilitadas las notificaciones)
  EVENT_REMINDER          // Recordatorio 24h antes
  USER_APPROVED           // Tu solicitud fue aprobada
  USER_REJECTED           // Tu solicitud fue rechazada
  ADMIN_NEW_USER          // Nuevo usuario pendiente de aprobación (para admins)
  INVITATION_VALIDATED    // Tu invitación fue validada
  INVITATION_REJECTED     // Tu invitación fue rechazada
  WAITLIST_SPOT_AVAILABLE // Plaza disponible desde waitlist
  BADGE_UNLOCKED          // Badge desbloqueado
}

// Notificaciones del sistema
model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String           @db.Text

  // Datos adicionales (JSON)
  metadata  Json?            // { eventId, eventTitle, etc. }

  // Estado
  read      Boolean          @default(false)
  readAt    DateTime?

  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// Definiciones de badges (catálogo estático)
model BadgeDefinition {
  id            String        @id @default(cuid())
  category      BadgeCategory
  level         Int           // 1-6
  name          String        // "Euro-turista", "Capataz de Recursos", etc.
  description   String?       @db.Text
  iconUrl       String?       // URL del icono del badge
  requiredCount Int           // Juegos necesarios: 5, 10, 20, 40, 70, 100

  // Relaciones
  userBadges    UserBadge[]

  createdAt     DateTime      @default(now())

  @@unique([category, level])
  @@index([category])
  @@index([level])
}

// Badges desbloqueados por usuarios
model UserBadge {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeDefinitionId String
  badgeDefinition   BadgeDefinition @relation(fields: [badgeDefinitionId], references: [id], onDelete: Cascade)
  unlockedAt        DateTime        @default(now())

  @@unique([userId, badgeDefinitionId])
  @@index([userId])
  @@index([badgeDefinitionId])
}

// Historial de juegos jugados (para tracking de badges)
model GamePlayHistory {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId      String
  event        Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  gameName     String         // Nombre del juego jugado
  gameCategory BadgeCategory? // Categoría del juego (puede ser null si no está categorizado)
  playedAt     DateTime       @default(now())
  createdAt    DateTime       @default(now())

  @@index([userId])
  @@index([eventId])
  @@index([gameCategory])
  @@index([playedAt])
}
